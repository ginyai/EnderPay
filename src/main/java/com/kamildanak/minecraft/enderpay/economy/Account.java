package com.kamildanak.minecraft.enderpay.economy;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.kamildanak.minecraft.enderpay.EnderPay;
import com.kamildanak.minecraft.enderpay.proxy.ISettings;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraftforge.fml.common.Loader;
import org.spongepowered.api.Sponge;
import org.spongepowered.api.event.cause.Cause;
import org.spongepowered.api.event.cause.EventContext;
import org.spongepowered.api.service.economy.Currency;
import org.spongepowered.api.service.economy.EconomyService;
import org.spongepowered.api.service.economy.account.UniqueAccount;

import javax.annotation.Nullable;
import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.math.BigDecimal;
import java.util.HashMap;
import java.util.UUID;

public class Account {
    private static HashMap<String, Account> objects = new HashMap<>();
    private static ISettings settings;
    private static IDayHelper dayHelper;
    private static IPlayerHelper playerHelper;
    private static File location;
    private boolean changed;

    private UUID uuid;
    private long balance;
    private long lastLogin;
    private long lastCountActivity;

    private Account(UUID uuid) {
        this.uuid = uuid;
        this.balance = settings.getStartBalance();
        long now = dayHelper.getCurrentDay();
        this.lastLogin = now;
        this.lastCountActivity = now;
        this.changed = true;
    }

    public static Account get(EntityPlayer player) {
        return get(player.getUniqueID());
    }

    @Nullable
    public static Account get(UUID uuid) {
        Account account = objects.get(uuid.toString());
        if (account != null) return account;

        //sponge
        if(Loader.isModLoaded("sponge")){
            EconomyService service = Sponge.getServiceManager().provideUnchecked(EconomyService.class);
            Currency currency = service.getDefaultCurrency();
            UniqueAccount spongeAccount = service.getOrCreateAccount(uuid).orElse(null);
            if(spongeAccount == null){
                return null;
            }
            account = new SpongeAccount(uuid, currency, spongeAccount);
            objects.put(uuid.toString(), account);
            return account;
        }

        if (location == null) return null;
        //noinspection ResultOfMethodCallIgnored
        location.mkdirs();

        account = new Account(uuid);
        objects.put(uuid.toString(), account);

        File file = account.getFile();
        if (!file.exists()) return account;

        try {
            account.read();
        } catch (IOException e) {
            e.printStackTrace();
        }
        return account;
    }

    public static void clear() {
        Account.location = null;
        Account.objects.clear();
    }

    public static void setLocation(File location) {
        Account.location = location;
    }

    public boolean update() {
        long now = dayHelper.getCurrentDay();
        long activityDeltaDays = now - this.lastCountActivity;
        this.lastCountActivity = now;

        if (activityDeltaDays == 0) return false;

        if (settings.isStampedMoney()) {
            if (activityDeltaDays <= settings.getResetLoginDelta()) {
                if (activityDeltaDays>2000) {
                    this.balance = (long) Math.ceil(this.balance * Math.pow((1 - ((double) settings.getStampedMoneyPercent()) / 100), activityDeltaDays));
                } else {
                    for (int i = 0; i < activityDeltaDays; i++)
                        this.balance -= Math.ceil((double) (this.balance * settings.getStampedMoneyPercent()) / 100);
                }
            }
        }
        if (settings.isBasicIncome() && playerHelper.isPlayerLoggedIn(uuid)) {
            long loginDeltaDays = (now - this.lastLogin);
            if (settings.getMaxLoginDelta() > 0 && loginDeltaDays > settings.getMaxLoginDelta())
                loginDeltaDays = settings.getMaxLoginDelta();
            this.lastLogin = now;
            this.balance += loginDeltaDays * settings.getBasicIncomeAmount();
        }
        if (settings.getResetLoginDelta() > 0 && activityDeltaDays > settings.getResetLoginDelta()) {
            this.balance = settings.getStartBalance();
        }
        return activityDeltaDays > 0;
    }

    public void writeIfChanged() throws IOException {
        if (changed) write();
    }

    private File getFile() {
        return new File(location, uuid + ".json");
    }

    private void read() throws IOException {
        read(getFile());
    }

    private void read(File file) throws IOException {
        changed = false;

        JsonParser jsonParser = new JsonParser();
        try {

            Object obj = jsonParser.parse(new FileReader(file));
            JsonObject jsonObject = (JsonObject) obj;
            balance = jsonObject.get("balance").getAsLong();
            lastLogin = jsonObject.get("lastLogin").getAsLong();
            lastCountActivity = jsonObject.get("lastCountActivity").getAsLong();

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private void write() throws IOException {
        write(getFile());
    }

    private void write(File location) throws IOException {
        JsonObject obj = new JsonObject();
        obj.addProperty("balance", balance);
        obj.addProperty("lastLogin", lastLogin);
        obj.addProperty("lastCountActivity", lastCountActivity);
        try (FileWriter file = new FileWriter(location)) {
            String str = obj.toString();
            file.write(str);
        }
        changed = false;
    }

    public long getBalance() {
        return balance;
    }

    public void setBalance(long v) {
        balance = v;
        changed = true;
        playerHelper.send(uuid, balance);
    }

    public void addBalance(long v) {
        setBalance(balance + v);
    }

    public static void setInterfaces(ISettings settings, IDayHelper dayHelper, IPlayerHelper playerHelper) {
        Account.settings = settings;
        Account.dayHelper = dayHelper;
        Account.playerHelper = playerHelper;
    }

    private static class SpongeAccount extends Account{

        private Currency currency;
        private UniqueAccount spongeAccount;

        private SpongeAccount(UUID uuid, Currency currency, @Nullable UniqueAccount spongeAccount) {
            super(uuid);
            this.currency = currency;
            this.spongeAccount = spongeAccount;
        }

        @Override
        public boolean update() {
            return false;
        }

        @Override
        public void writeIfChanged() throws IOException {
            //Nothing
        }

        @Override
        public long getBalance() {
            return spongeAccount.getBalance(currency).longValue();
        }

        @Override
        public void setBalance(long v) {
            spongeAccount.setBalance(currency,BigDecimal.valueOf(v),Cause.of(EventContext.empty(),EnderPay.instance));
        }

        @Override
        public void addBalance(long v) {
            if(v>=0){
                spongeAccount.deposit(currency,BigDecimal.valueOf(v),Cause.of(EventContext.empty(),EnderPay.instance));
            }else {
                spongeAccount.withdraw(currency,BigDecimal.valueOf(-v),Cause.of(EventContext.empty(),EnderPay.instance));
            }
        }
    }
}
